<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å•†å ´æ«ƒä½è¨˜æ†¶æ¸¬é©—</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.quiz-box {
  background: #fff;
  padding: 20px;
  max-width: 650px;
  margin: auto;
  border-radius: 8px;
}
.option {
  margin: 8px 0;
}
button {
  margin-top: 15px;
  padding: 8px 16px;
}
.correct {
  color: green;
}
.wrong {
  color: red;
}
</style>
</head>
<body>

<div class="quiz-box" id="quiz">
  <h2 id="question"></h2>
  <div id="options"></div>
  <p id="feedback"></p>
  <button onclick="restartQuiz()">é‡æ–°é–‹å§‹</button>
  <p id="score"></p>
</div>

<script>
let data = [];

async function loadData() {
  const response = await fetch("https://script.google.com/macros/s/AKfycbzUImVC1MJ1av0esYAMojYI7etSWP-w1ERGjqpukZCB3UaSFOBkTsMkB0AF6LagalOn/exec");
  const raw = await response.json();

  data = raw
    .filter(row => row["åº—å"] && row["ä½ç½®"] && row["å•†å“"]) // éæ¿¾ç©ºç™½åˆ—
    .map(row => ({
      name: row["åº—å"],
      location: row["ä½ç½®"],
      product: row["å•†å“"],
      booth: row["æ«ƒè™Ÿ"]
    }));

  restartQuiz();
}

loadData();

</script>
<script>
const QUESTION_COUNT = 20;
let questions = [];
let current = 0;
let score = 0;
let answerHistory = [];

// âœ… æ­£ç¢ºæ´—ç‰Œï¼ˆFisherâ€“Yatesï¼‰
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// âœ… éš¨æ©ŸæŒ‘é¡Œ + åªå• åœ°é» / å•†å“
function generateQuestions() {
  const shuffled = shuffle([...data]).slice(0, QUESTION_COUNT);

  questions = shuffled.map(item => {
    const type = Math.random() > 0.5 ? "location" : "product";
    return { ...item, type };
  });
}

function getCorrectAnswer(q) {
  return q.type === "location" ? q.location : q.product;
}

function getQuestionText(q) {
  return q.type === "location"
    ? `${q.name} ä½æ–¼å“ªå€‹ä½ç½®ï¼Ÿ`
    : `${q.name} ä¸»è¦è²©å”®ä»€éº¼å•†å“ï¼Ÿ`;
}

// âœ… ç”¢ç”Ÿä¸é‡è¤‡é¸é …
function generateOptions(correct, type) {
  let pool = [];

  if (type === "location") {
    pool = [...new Set(data.map(d => d.location))];
  } else {
    pool = [...new Set(data.map(d => d.product))];
  }

  pool = pool.filter(p => p !== correct);
  const wrongs = shuffle(pool).slice(0, 3);

  return shuffle([correct, ...wrongs]);
}

function showQuestion() {
  const q = questions[current];
  const correct = getCorrectAnswer(q);
  const options = generateOptions(correct, q.type);

  document.getElementById("feedback").innerHTML = "";
  document.getElementById("question").innerText =
    `ç¬¬ ${current + 1} é¡Œï¼š${getQuestionText(q)}`;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.onclick = () => selectAnswer(opt, correct);
    optionsDiv.appendChild(btn);
  });

  document.getElementById("score").innerText = `ç›®å‰åˆ†æ•¸ï¼š${score}`;
}

function selectAnswer(selected, correct) {
  const feedback = document.getElementById("feedback");
  const q = questions[current];
  const questionText = getQuestionText(q);

  const isCorrect = selected === correct;

  if (isCorrect) {
    score += 5;
    feedback.innerHTML = `<span class="correct">âœ” æ­£ç¢ºï¼</span>`;
  } else {
    feedback.innerHTML =
      `<span class="wrong">âœ˜ éŒ¯èª¤</span><br>æ­£ç¢ºç­”æ¡ˆï¼š<b>${correct}</b>`;
  }

  // â­ å„²å­˜ç´€éŒ„
  answerHistory.push({
    question: questionText,
    selected: selected,
    correct: correct,
    result: isCorrect
  });

  setTimeout(() => {
    current++;
    if (current >= questions.length) {
      endQuiz();
    } else {
      showQuestion();
    }
  }, 1200);
}

function endQuiz() {
  document.getElementById("question").innerText = "æ¸¬é©—çµæŸ ğŸ‰";
  document.getElementById("options").innerHTML = "";

  let resultHTML = `<h3>ä½ çš„åˆ†æ•¸ï¼š${score} / ${QUESTION_COUNT * 5}</h3>`;
  resultHTML += "<hr><h3>ğŸ“‹ ä½œç­”ç´€éŒ„</h3>";

  answerHistory.forEach((item, index) => {
    resultHTML += `
      <div style="margin-bottom:10px;">
        <b>ç¬¬ ${index + 1} é¡Œï¼š</b>${item.question}<br>
        ä½ çš„ç­”æ¡ˆï¼š 
        <span class="${item.result ? 'correct' : 'wrong'}">
          ${item.selected}
        </span><br>
        æ­£ç¢ºç­”æ¡ˆï¼š <b>${item.correct}</b>
      </div>
    `;
  });

  document.getElementById("feedback").innerHTML = resultHTML;
}

function restartQuiz() {
  current = 0;
  score = 0;
  answerHistory = [];   // â­ æ¸…ç©ºç´€éŒ„
  generateQuestions();
  showQuestion();
}
restartQuiz();
</script>